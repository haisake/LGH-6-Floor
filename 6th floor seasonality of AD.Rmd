---
title: "LGH 6th floor seasonality of AD"
author: "Hans Aisake"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#move to a main file later I guess
#set library and working directories
libPath <-"H:/Hans/R Libraries"
.libPaths(libPath) #set the library path

#set WD
wd <- "//vch.ca/departments/VCHDecisionSupport/Coastal_Richmond_SI/2019-08-28_LGH_6th-floor-transfers-seasonality"
setwd(wd)

library(odbc) #for database connections
library(Rmarkdown)
library(tidyverse)
library(prophet)
library(here)
library(lubridate)
library(readxl)

# dsn_name <- "AISAKE-DENODO" #my OBDC denodo connection name
# channel <- DBI::dbConnect(odbc::odbc(), dsn = dsn_name)
# data <- dplyr::tbl(channel, dbplyr::in_schema("publish","activity_loc_room"))

#load source files

#user functions
toDate <- function(year, month, day) {
    ISOdate(year, month, day)
}
```

##Summary

<placeholder>
```{r summary_and_load}

# read in data -------
  df1.activity <- read_excel(path="./Input/transfersDataLGH6Floor.xlsx", sheet = "data") 

````

## Entries


```{r summary_and_load}

  # aggregate it to have entries by TOD, DOW and Date
  df2.entries <- df1.activity %>%
    group_by(beg_year, beg_month, beg_day, beg_dow, beg_tod) %>%
    summarize( entries =n_distinct(encntr_id))
  df2.entries <- df2.entries %>% ungroup()
  df2.entries$entryDate <- toDate(df2.entries$beg_year, df2.entries$beg_month, df2.entries$beg_day)
  
  #shorten df Name
  x <- df2.entries  
  u_dates <- data.frame( entryDate = seq(min(x$entryDate), max(x$entryDate),  by = "1 day"), foo=1) #unique dates
  u_hours <- data.frame( hours = seq(0, 23, 1), foo=1)
  u_DOW   <- data.frame( DOW = seq(1, 7, 1), foo=1)
  placeholder <- u_dates %>% left_join(u_hours, by="foo") %>% left_join(u_DOW, by="foo") %>% select(-foo)
  placeholder$key <- apply( placeholder[, c("entryDate","hours","DOW")] , 1 , paste , collapse = "ZZ" ) #key for joinging 
  x$key<- apply( x[, c("entryDate","beg_tod","beg_dow")] , 1 , paste , collapse = "ZZ" ) #key for joining
  
  #
  placeholder <- placeholder %>%  
    left_join( x, by="key", suffix=c("",".y")) %>% 
    select(names(placeholder),"entries", -"key")
  placeholder$entries[is.na(placeholder$entries)] <- 0  #set 0s
  
  #write.csv(placeholder, "./Wip/test.csv")
  
  
````

## Departures


```{r summary_and_load}
  # aggregate it to have exists by TOD, DOW and Date
  df3.departures <- df1.activity %>%
    group_by(end_year, end_month, end_day, end_dow, end_tod) %>%
    summarize( entries =n_distinct(encntr_id))
  df3.departures <- df3.departures %>% ungroup()
  df3.departures$departureDate <- toDate(df3.departures$end_year, df3.departures$end_month,df3.departures$end_day)
  
  #to add in 0s
  u_dates <- seq(min(df3.departures$as.Date(end_date),
                                               by = "1 day"))
  
  #create an all combos data set to facilitate identification of 0 transfers in combo
  #list of dimensions for the combos
  p = data.frame( transFP = unique( x$transFP), foo=1)
  q = data.frame( TransferDoW = unique( x$TransferDoW), foo=1)
  r = data.frame( TransferHour = unique( x$TransferHour), foo=1)
  s = data.frame( OrigService = as.character(unique( x$OrigService)), foo=1)
  t = data.frame( TransService = as.character(unique( x$TransService)), foo=1)
  placeholder <- p %>% left_join(q, by="foo") %>% left_join(r, by="foo") %>% left_join(s, by="foo") %>% left_join(t, by="foo") %>% select(-foo)

  #need a column to join on so we have to make a unique dummy column for DPLYR
  placeholder$key <-apply( placeholder , 1 , paste , collapse = "ZZ" )
  x$key <- apply( x[, c("transFP","TransferDoW","TransferHour","OrigService","TransService")] , 1 , paste , collapse = "ZZ" )
  
  #combine the all combos palceholder with the observed values
  placeholder <- placeholder %>%  
    left_join( x, by="key", suffix=c("",".y")) %>% 
    select(names(placeholder),"NumTransfers", -"key")
  placeholder$NumTransfers[is.na(placeholder$NumTransfers)] <- 0  #set 0s
  dataList$capplanTransfer_df <- placeholder #put the result into the data list
 



df3.6w <- 
  df1.census_daily %>% 
  filter(NursingUnitDesc == "LGH 6W") %>% 
  select(censusdate, 
         Census) %>% 
  rename(ds = censusdate, 
         y = Census)

df4.sco <- 
  df1.census_daily %>% 
  filter(NursingUnitDesc == "LGH SCO") %>% 
  select(censusdate, 
         Census) %>% 
  rename(ds = censusdate, 
         y = Census)


#+ models ----

#' ## Fit model for LGH 6E 
m1 <- prophet(df2.6e)

future <- make_future_dataframe(m1, 
                                periods = 10,
                                freq = "day")  

fcast <- predict(m1, future)

# plots 
plot(m1, fcast)
prophet_plot_components(m1, fcast)





#' ## Fit model for LGH 6W
m2 <- prophet(df3.6w)

future <- make_future_dataframe(m2, 
                                periods = 10,
                                freq = "day")  

fcast <- predict(m2, future)

# plots 
plot(m2, fcast)
prophet_plot_components(m2, fcast)




#' ## Fit model for LGH SCO
m3 <- prophet(df4.sco)

future <- make_future_dataframe(m3, 
                                periods = 10,
                                freq = "day")  

fcast <- predict(m3, future)

# plots 
plot(m3, fcast)
prophet_plot_components(m3, fcast)
