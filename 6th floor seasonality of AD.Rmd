---
title: "LGH 6th floor seasonality of AD"
author: "Hans Aisake"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#move to a main file later I guess
#set library and working directories
libPath <-"H:/Hans/R Libraries"
.libPaths(libPath) #set the library path

#set WD
wd <- "//vch.ca/departments/VCHDecisionSupport/Coastal_Richmond_SI/2019-08-28_LGH_6th-floor-transfers-seasonality"
setwd(wd)

library(odbc) #for database connections
library(Rmarkdown)
library(tidyverse)
library(prophet)
library(here)
library(lubridate)
library(readxl)

# dsn_name <- "AISAKE-DENODO" #my OBDC denodo connection name
# channel <- DBI::dbConnect(odbc::odbc(), dsn = dsn_name)
# data <- dplyr::tbl(channel, dbplyr::in_schema("publish","activity_loc_room"))

#load source files

```

## R Markdown

<placeholder>
```{r cars}

# read in data -------
  df1.activity <- read_excel(path="./Input/transfersDataLGH6Floor.xlsx", sheet = "data") 
  # 
  # entry_startDate <- min(df1.activity$beg_effective_date_id)
  # entry_startDate <- max(df1.activity$beg_effective_date_id)
  # departure_endDate <- min(df1.activity$end_effective_date_id)
  # departure_endDate <- max(df1.activity$end_effective_date_id)

# aggregate it to have entries by TOD, DOW and Date
  df2.entries <- df1.activity %>%
    group_by(beg_effective_date_id, beg_dow, beg_tod) %>%
    summarize( entries =n_distinct(encntr_id))
  df2.entries <- df2.entries %>% ungroup()

# aggregate it to have exists by TOD, DOW and Date
  df3.departures <- df1.activity %>%
    group_by(end_effective_date_id, end_dow, end_tod) %>%
    summarize( entries =n_distinct(encntr_id))
  df3.departures <- df3.departures %>% ungroup()
  
#fill dates
  fill_dates(df2.entries, beg_effective_date_id, entry_startDate, entry_endDate)

  
  #note who has ace service
  index  <- which(x$Orig_ACE_Flag =="ACE") #ace patients
  index2 <- which(x$Trans_ACE_Flag =="ACE") #ace patients
  x$OrigService[index] <- paste0("ACE-", x$OrigService[index])
  x$TransService[index2] <- paste0("ACE-", x$TransService[index2])
  
  #remove FP's without sufficiently compelte data
  y <- x %>% group_by( transFP,TransferDate ) %>% summarize( c = n(), fpStart = min(fiscalperiodstartdate), fpEnd = max(fiscalperiodenddate) )
  y <- y %>% ungroup()
  y <- y %>% group_by( transFP ) %>% summarize( c =n(), fpStart = min(fpStart), fpEnd = max(fpEnd) )
  y$p_length = as.numeric(y$fpEnd-y$fpStart+1)
  m_l <- min(y$transFP[which(y$c/y$p_length >=0.8)])
  m_m <- max(y$transFP[which(y$c/y$p_length >=0.8)])
  index3 <-  y$transFP[y$transFP >= m_l & y$transFP <= m_m]
  index4 <- which(x$transFP %in% index3)
  x <- x[index4,]

  #aggregate up to service and drop columns and rename
  x <- x %>%
    group_by(transFY, transFP, TransferDoW, TransferHour, OrigService, TransService) %>%
    summarize( NumTransfers = n())
  
  #create an all combos data set to facilitate identification of 0 transfers in combo
  #list of dimensions for the combos
  p = data.frame( transFP = unique( x$transFP), foo=1)
  q = data.frame( TransferDoW = unique( x$TransferDoW), foo=1)
  r = data.frame( TransferHour = unique( x$TransferHour), foo=1)
  s = data.frame( OrigService = as.character(unique( x$OrigService)), foo=1)
  t = data.frame( TransService = as.character(unique( x$TransService)), foo=1)
  placeholder <- p %>% left_join(q, by="foo") %>% left_join(r, by="foo") %>% left_join(s, by="foo") %>% left_join(t, by="foo") %>% select(-foo)

  #need a column to join on so we have to make a unique dummy column for DPLYR
  placeholder$key <-apply( placeholder , 1 , paste , collapse = "ZZ" )
  x$key <- apply( x[, c("transFP","TransferDoW","TransferHour","OrigService","TransService")] , 1 , paste , collapse = "ZZ" )
  
  #combine the all combos palceholder with the observed values
  placeholder <- placeholder %>%  
    left_join( x, by="key", suffix=c("",".y")) %>% 
    select(names(placeholder),"NumTransfers", -"key")
  placeholder$NumTransfers[is.na(placeholder$NumTransfers)] <- 0  #set 0s
  dataList$capplanTransfer_df <- placeholder #put the result into the data list
 



df3.6w <- 
  df1.census_daily %>% 
  filter(NursingUnitDesc == "LGH 6W") %>% 
  select(censusdate, 
         Census) %>% 
  rename(ds = censusdate, 
         y = Census)

df4.sco <- 
  df1.census_daily %>% 
  filter(NursingUnitDesc == "LGH SCO") %>% 
  select(censusdate, 
         Census) %>% 
  rename(ds = censusdate, 
         y = Census)


#+ models ----

#' ## Fit model for LGH 6E 
m1 <- prophet(df2.6e)

future <- make_future_dataframe(m1, 
                                periods = 10,
                                freq = "day")  

fcast <- predict(m1, future)

# plots 
plot(m1, fcast)
prophet_plot_components(m1, fcast)





#' ## Fit model for LGH 6W
m2 <- prophet(df3.6w)

future <- make_future_dataframe(m2, 
                                periods = 10,
                                freq = "day")  

fcast <- predict(m2, future)

# plots 
plot(m2, fcast)
prophet_plot_components(m2, fcast)




#' ## Fit model for LGH SCO
m3 <- prophet(df4.sco)

future <- make_future_dataframe(m3, 
                                periods = 10,
                                freq = "day")  

fcast <- predict(m3, future)

# plots 
plot(m3, fcast)
prophet_plot_components(m3, fcast)
